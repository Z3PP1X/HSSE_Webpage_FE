<div class="grid grid-cols-12 min-h-screen bg-gray-50">
  <!-- Main Content - Full Width now that nav is global overlay -->
  <div class="col-span-12 p-8 ml-16"> <!-- Added ml-16 to offset fixed navbar -->

    <!-- Loading State -->
    @if (isLoading) {
    <div class="flex flex-col items-center justify-center h-full min-h-[50vh]">
      <div class="w-12 h-12 border-4 border-sixt-orange border-t-transparent rounded-full animate-spin mb-4"></div>
      <div class="text-gray-500 font-medium">Processing...</div>
    </div>
    }

    <!-- Error State -->
    @if (error) {
    <div
      class="bg-red-50 border border-red-200 text-red-700 p-6 rounded-xl flex flex-col items-center gap-4 max-w-lg mx-auto mt-10">
      <svg class="w-12 h-12 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
          d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
        </path>
      </svg>
      <span class="text-lg font-semibold">{{ error }}</span>
      <button (click)="retryLoadConfig()"
        class="px-6 py-2 bg-white border border-red-200 shadow-sm rounded-lg hover:bg-red-50 transition-colors text-red-700 font-medium">
        Try Again
      </button>
    </div>
    }

    @if (!isLoading && !error) {

    <!-- STEP: FORM -->
    @if (step === 'form') {
    <app-dynamic-form [config]="formConfig" (formSubmit)="handleFormSubmit($event)" class="block animate-fadeIn">
    </app-dynamic-form>
    }

    <!-- STEP: REVIEW -->
    @if (step === 'review') {
    <div class="max-w-5xl mx-auto animate-fadeIn">

      <div class="flex items-center justify-between mb-8">
        <div>
          <h2 class="text-3xl font-bold text-gray-900">Review your Alarmplan</h2>
          <p class="text-gray-500 mt-1">Please check the details below before generating the PDF.</p>
        </div>
        <div
          class="bg-blue-50 text-blue-700 px-4 py-2 rounded-lg text-sm font-medium border border-blue-100 flex items-center gap-2">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">
            </path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
            </path>
          </svg>
          Preview Mode
        </div>
      </div>

      <!-- Preview Container -->
      <!-- Preview Container -->
      <!-- Preview Container -->
      <!-- Preview Container -->
      <div
        class="bg-gray-200 rounded-xl overflow-hidden shadow-inner border border-gray-300 p-8 flex justify-center mb-8 relative"
        (mousedown)="startDrag($event)" (mousemove)="onDrag($event)" (mouseup)="stopDrag()" (mouseleave)="stopDrag()"
        [style.cursor]="isDragging ? 'grabbing' : 'grab'">

        <div class="absolute inset-0 pattern-grid-lg opacity-5 pointer-events-none"></div>

        <!-- Zoom Controls (Fixed inside container) -->
        <div class="absolute bottom-4 right-4 z-40 flex flex-col gap-2 pointer-events-auto"
          (mousedown)="$event.stopPropagation()">
          <button (click)="zoomIn()"
            class="p-2 bg-white rounded-lg shadow-md hover:bg-gray-50 text-gray-700 border border-gray-200 transition-all"
            title="Zoom In">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
              </path>
            </svg>
          </button>
          <div
            class="bg-white/90 backdrop-blur px-2 py-1 rounded text-xs font-mono text-center shadow-sm border border-gray-200">
            {{ (zoomLevel * 100) | number:'1.0-0' }}%
          </div>
          <button (click)="zoomOut()"
            class="p-2 bg-white rounded-lg shadow-md hover:bg-gray-50 text-gray-700 border border-gray-200 transition-all"
            title="Zoom Out">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
            </svg>
          </button>
        </div>

        <!-- Scaled Preview Wrapper to fit viewing area (A4 Landscape) -->
        <!-- A4 Landscape (297mm x 210mm) is approx 1123px x 794px at 96PPI. 
             We force these dimensions and scale it down to fit the UI. -->
        <div class="relative overflow-hidden transition-transform duration-75 origin-center shadow-2xl bg-white"
          [style.width]="'297mm'" [style.height]="'210mm'"
          [style.transform]="'translate(' + panX + 'px, ' + panY + 'px) scale(' + zoomLevel + ')'"
          [class.transition-none]="isDragging" [class.duration-300]="!isDragging">

          <!-- Direct Component Usage for Preview -->
          <app-alarmplan class="block w-full h-full"></app-alarmplan>

          <!-- Overlay to prevent interaction -->
          <div class="absolute inset-0 z-20 bg-transparent"></div>
        </div>
      </div>

      <!-- Action Bar -->
      <div
        class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 flex justify-between items-center sticky bottom-6 z-30">
        <button (click)="backToForm()"
          class="px-6 py-3 rounded-lg border border-gray-300 text-gray-700 font-semibold hover:bg-gray-50 transition-all flex items-center gap-2 group">
          <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18">
            </path>
          </svg>
          Back to Editing
        </button>

        <button (click)="onConfirmReview()"
          class="px-8 py-3 rounded-lg bg-sixt-orange text-white font-bold text-lg shadow-lg hover:bg-orange-600 hover:shadow-xl hover:-translate-y-0.5 transition-all flex items-center gap-2">
          <span>Confirm & Download PDF</span>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
        </button>
      </div>

    </div>
    }
    }
  </div>

  <!-- Hidden/Background PDF Component -->
  <!-- Always strictly handle visibility via showPdfComponent to avoid DOM pollution -->
  @if (showPdfComponent) {
  <div class="absolute left-[-9999px] top-0">
    <app-pdf></app-pdf>
  </div>
  }
</div>
<div class="grid grid-cols-12 min-h-screen bg-zinc-950 font-sans text-zinc-100">
  <!-- Main Content - Full Width now that nav is global overlay -->
  <div class="col-span-12 p-8 ml-16"> <!-- Added ml-16 to offset fixed navbar -->

    <!-- Loading State -->
    @if (isLoading) {
    <div class="flex flex-col items-center justify-center h-full min-h-[50vh]">
      <div
        class="w-12 h-12 border-4 border-sixt-orange border-t-transparent rounded-full animate-spin mb-4 shadow-[0_0_15px_rgba(255,95,0,0.3)]">
      </div>
      <div class="text-zinc-400 font-medium tracking-wide">Processing...</div>
    </div>
    }

    <!-- Error State -->
    @if (error) {
    <div
      class="bg-red-950/20 border border-red-900/50 text-red-400 p-8 rounded-2xl flex flex-col items-center gap-4 max-w-lg mx-auto mt-20 backdrop-blur-sm shadow-xl">
      <div class="p-4 bg-red-900/20 rounded-full">
        <svg class="w-10 h-10 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
            d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z">
          </path>
        </svg>
      </div>
      <span class="text-xl font-bold bg-clip-text text-transparent bg-gradient-to-br from-red-400 to-red-600">Error
        Occurred</span>
      <span class="text-center text-zinc-400">{{ error }}</span>
      <button (click)="retryLoadConfig()"
        class="mt-4 px-8 py-3 bg-red-900/20 border border-red-500/30 text-red-400 rounded-xl hover:bg-red-900/40 hover:border-red-500/50 transition-all font-semibold">
        Try Again
      </button>
    </div>
    }

    @if (!isLoading && !error) {

    <!-- STEP: FORM -->
    @if (step === 'form' && formConfig) {
    <app-dynamic-form [config]="formConfig" (formSubmit)="handleFormSubmit($event)" class="block animate-fadeIn">
    </app-dynamic-form>
    }

    <!-- STEP: REVIEW -->
    @if (step === 'review') {
    <div class="max-w-6xl mx-auto animate-fadeIn pb-20">

      <div class="flex items-center justify-between mb-10">
        <div>
          <h2 class="text-4xl font-bold text-white mb-2 tracking-tight">Review Inspection</h2>
          <p class="text-zinc-400 text-lg">Please verify all details before generating the final report.</p>
        </div>
        <div
          class="bg-blue-500/10 text-blue-400 px-5 py-2.5 rounded-xl text-sm font-semibold border border-blue-500/20 flex items-center gap-3 shadow-lg shadow-blue-900/20">
          <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z">
            </path>
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z">
            </path>
          </svg>
          Preview Mode
        </div>
      </div>

      <!-- Preview Container -->
      <div
        class="bg-zinc-900/50 rounded-2xl overflow-hidden shadow-2xl border border-zinc-800 p-10 flex justify-center mb-10 relative backdrop-blur-sm"
        (mousedown)="startDrag($event)" (mousemove)="onDrag($event)" (mouseup)="stopDrag()" (mouseleave)="stopDrag()"
        [style.cursor]="isDragging ? 'grabbing' : 'grab'">

        <!-- Dot Pattern Background -->
        <div class="absolute inset-0 opacity-[0.03]"
          style="background-image: radial-gradient(#fff 1px, transparent 1px); background-size: 20px 20px;"></div>

        <!-- Zoom Controls (Fixed inside container) -->
        <div class="absolute bottom-6 right-6 z-40 flex flex-col gap-3 pointer-events-auto"
          (mousedown)="$event.stopPropagation()">
          <button (click)="zoomIn()"
            class="p-3 bg-zinc-800 text-white rounded-xl shadow-lg hover:bg-zinc-700 border border-zinc-700 transition-all active:scale-95"
            title="Zoom In">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6">
              </path>
            </svg>
          </button>
          <div
            class="bg-zinc-900/90 backdrop-blur px-3 py-1.5 rounded-lg text-xs font-mono text-center text-zinc-400 border border-zinc-700 shadow-md">
            {{ (zoomLevel * 100) | number:'1.0-0' }}%
          </div>
          <button (click)="zoomOut()"
            class="p-3 bg-zinc-800 text-white rounded-xl shadow-lg hover:bg-zinc-700 border border-zinc-700 transition-all active:scale-95"
            title="Zoom Out">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
            </svg>
          </button>
        </div>

        <!-- Scaled Preview Wrapper -->
        <div
          class="relative overflow-hidden transition-transform duration-75 origin-center shadow-[0_0_50px_rgba(0,0,0,0.5)] bg-white text-black rounded-sm"
          [style.width]="'297mm'" [style.height]="'210mm'"
          [style.transform]="'translate(' + panX + 'px, ' + panY + 'px) scale(' + zoomLevel + ')'"
          [class.transition-none]="isDragging" [class.duration-300]="!isDragging">

          <!-- Direct Component Usage for Preview -->
          <app-alarmplan class="block w-full h-full"></app-alarmplan>

          <!-- Overlay to prevent interaction -->
          <div class="absolute inset-0 z-20 bg-transparent"></div>
        </div>
      </div>

      <!-- Action Bar -->
      <div
        class="bg-zinc-900 p-6 rounded-2xl shadow-xl border border-zinc-800 flex justify-between items-center sticky bottom-6 z-30 ring-1 ring-white/5">
        <button (click)="backToForm()"
          class="px-8 py-4 rounded-xl border border-zinc-700 text-zinc-300 font-semibold hover:bg-zinc-800 hover:text-white transition-all flex items-center gap-3 group active:scale-95">
          <svg class="w-5 h-5 group-hover:-translate-x-1 transition-transform" fill="none" stroke="currentColor"
            viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18">
            </path>
          </svg>
          Edit Details
        </button>

        <button (click)="onConfirmReview()"
          class="px-10 py-4 rounded-xl bg-gradient-to-r from-sixt-orange to-orange-500 text-white font-bold text-lg shadow-lg hover:shadow-orange-500/20 hover:-translate-y-0.5 transition-all flex items-center gap-3 active:scale-95">
          <span>Confirm & Generate PDF</span>
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
              d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
          </svg>
        </button>
      </div>

    </div>
    }
    }
  </div>

  <!-- Hidden/Background PDF Component -->
  <!-- Always strictly handle visibility via showPdfComponent to avoid DOM pollution -->
  @if (showPdfComponent) {
  <div class="absolute left-[-9999px] top-0">
    <app-pdf></app-pdf>
  </div>
  }
</div>